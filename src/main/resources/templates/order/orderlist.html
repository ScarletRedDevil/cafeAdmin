<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>상품목록</title>
  <th:block th:replace="~{fragments/header_link :: header_link}"/>
  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="/admin/dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
  </div>
  <!-- Navbar -->
  <th:block th:replace="~{fragments/navbar :: navbar}"/>
  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <th:block th:replace="~{fragments/brand_logo :: brand_logo}"/>
    <!-- Sidebar -->
    <th:block th:replace="~{fragments/sidebar :: sidebar}"/>
    <!-- Sidebar End -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">주문목록</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#"></a></li>
              <li class="breadcrumb-item active"></li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- main contents -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <div id="orderApp">
                      <order-view></order-view>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
        </div>
        <!-- /.row -->
      </div>
      <!-- /.container-fluid -->
    </section>
    <!-- /main contents -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="/admin/plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="/admin/plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<th:block th:replace="~{fragments/footer_link :: footer_link}"/>

<script type="text/javascript">

const OrderView = {
  template: `
    <div>
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>주문번호</th>
            <th>주문시간</th>
            <th>금액</th>
            <th>상태</th>
            <th>액션</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(orderSummary, index) in order_list" :key="index" aria-expanded="true">
            <td @click="fetchOrderDetail(orderSummary.ordersummary_idx)">{{orderSummary.ordersummary_idx}}</td>
            <td>{{orderSummary.orderdate}}</td>
            <td>{{orderSummary.total_pay}}</td>
            <td>{{orderSummary.orderstat.orderstat_name}}</td>
            <td>
              <button class="btn btn-success complete-order" @click.stop="completeOrder(orderSummary.ordersummary_idx)">주문 완료</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div v-if="order_detail_list">
        <h3>주문 상세</h3>
        <table class="table table-hover text-nowrap">
          <thead>
            <tr>
              <th>주문번호</th>
              <th>제품명</th>
              <th>수량</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(orderDetail, index) in order_detail_list" :key="index">
              <td>{{orderDetail.ordersummary_idx}}</td>
              <td>{{orderDetail.product_name}}</td>
              <td>{{orderDetail.ea}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `,
  data() {
    return {
      order_list: [],
      order_detail_list: null
    };
  },
  mounted() {
    this.fetchOrderList();
  },
  methods: {
    fetchOrderList() {
      axios.get('/admin/getorderlist')
        .then(response => {
          this.order_list = response.data;
        })
        .catch(error => {
          console.error('Error fetching order list:', error);
        });
    },
    fetchOrderDetail(orderSummaryIdx) {
      axios.get('/admin/orderdetail/' + orderSummaryIdx)
        .then(response => {
          this.order_detail_list = response.data;
        })
        .catch(error => {
          console.error('Error fetching order detail:', error);
        });
    },
    completeOrder(orderSummaryIdx) {
      axios.put('/admin/orderlist/' + orderSummaryIdx)
        .then(response => {
          alert('주문이 완료되었습니다.');
          this.fetchOrderList(); // 주문 목록 새로고침
        })
        .catch(error => {
          alert('주문 완료 처리 중 오류가 발생했습니다.');
          console.error('Error completing order:', error);
        });
    }
  }
};

const orderApp = Vue.createApp({
  components: {
    OrderView
  }
});

orderApp.mount("#orderApp");

</script>

</body>
</html>
